<!doctype html><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>MR Flashing v5.6</title>
<style>
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
header{padding:10px;border-bottom:1px solid #ddd;display:flex;gap:8px}
canvas{border:1px solid #999;touch-action:none;max-width:100%;background:#fff}
.controls{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-bottom:1px solid #eee}
.badge{background:#d00;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px}
.inline{position:absolute;transform:translate(-50%,-50%);z-index:5}
.inline input{padding:6px 8px;border:2px solid #d00;border-radius:8px;font-size:14px;min-width:90px;text-align:center}
.ruler{position:sticky;bottom:0;background:#222;color:#eee;padding:8px;display:flex;gap:10px;align-items:center}
.ruler input{flex:1}
</style>
<header>
  <button id='draw'>Draw</button><button id='select'>Select</button>
  <button id='undo'>Undo</button><button id='redo'>Redo</button>
</header>
<div class='controls'>
  Zoom <input id='zoom' type='range' min='0.5' max='3' step='0.1' value='1'>
  Scale(px/mm) <input id='scale' type='number' step='0.1' value='1'>
</div>
<div style='position:relative;padding:10px'>
  <canvas id='cv' width='980' height='560'></canvas>
  <div id='ov'></div>
</div>
<div class='ruler'>Length <input id='rl' type='range' min='0' max='5000' step='1'><span id='rv'>0</span> mm</div>
<script>
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');const ov=document.getElementById('ov');
let Z=1, pxPerMm=1, mode='draw'; document.getElementById('draw').onclick=()=>mode='draw'; document.getElementById('select').onclick=()=>mode='select';
document.getElementById('zoom').oninput=e=>{Z=parseFloat(e.target.value);draw()}; document.getElementById('scale').onchange=e=>{pxPerMm=parseFloat(e.target.value);draw()};
let path=[],hist=[],redo=[],drag=-1,sel=-1,lastTap=0;
function push(){hist.push(JSON.stringify(path));redo.length=0;}
document.getElementById('undo').onclick=()=>{if(hist.length){redo.push(JSON.stringify(path));path=JSON.parse(hist.pop());draw();}};
document.getElementById('redo').onclick=()=>{if(redo.length){hist.push(JSON.stringify(path));path=JSON.parse(redo.pop());draw();}};
function pos(e){const r=cv.getBoundingClientRect();return{x:((e.touches?e.touches[0].clientX:e.clientX)-r.left)/Z,y:((e.touches?e.touches[0].clientY:e.clientY)-r.top)/Z};}
cv.addEventListener('pointerdown',e=>{const p=pos(e);const now=Date.now();if(mode==='select'){let bd=1e9,bi=-1;for(let i=0;i<path.length;i++){const d=Math.hypot(p.x-path[i].x,p.y-path[i].y);if(d<bd){bd=d;bi=i;}}if(bd<12){drag=bi;push();}}else{if(now-lastTap<300){ } lastTap=now;push(); if(!path.length) path=[p]; else path.push(p);} draw();e.preventDefault();},{passive:false});
cv.addEventListener('pointermove',e=>{if(drag>-1){path[drag]=pos(e);draw();e.preventDefault();}},{passive:false});
cv.addEventListener('pointerup',e=>{drag=-1;e.preventDefault();},{passive:false});
function segs(){const s=[];for(let i=0;i<path.length-1;i++)s.push([path[i],path[i+1],i]);return s;}
function interior(pm,p,pn){const v1={x:pm.x-p.x,y:pm.y-p.y},v2={x:pn.x-p.x,y:pn.y-p.y};const dot=v1.x*v2.x+v1.y*v2.y;const l1=Math.hypot(v1.x,v1.y),l2=Math.hypot(v2.x,v2.y);const a=Math.acos(Math.max(-1,Math.min(1,dot/(l1*l2))))||0;return Math.min(a*180/Math.PI,180);}
function draw(){ctx.clearRect(0,0,cv.width,cv.height);if(!path.length)return;ctx.save();ctx.scale(Z,Z);ctx.lineWidth=2/Z;ctx.beginPath();ctx.moveTo(path[0].x,path[0].y);for(let i=1;i<path.length;i++)ctx.lineTo(path[i].x,path[i].y);ctx.stroke();ctx.restore();
  // length badges
  ctx.font='12px system-ui,-apple-system'; for(let i=0;i<path.length-1;i++){const a=path[i],b=path[i+1];const L=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm;const mx=(a.x+b.x)/2*Z,my=(a.y+b.y)/2*Z;badge(mx,my,Math.round(L)+' mm',i===sel);}
  // corner arcs + labels at arc midpoint
  const r=20; for(let i=1;i<path.length-1;i++){const pm=path[i-1],p=path[i],pn=path[i+1];let a1=Math.atan2(pm.y-p.y,pm.x-p.x),a2=Math.atan2(pn.y-p.y,pn.x-p.x);let start=a1,end=a2,d=end-start;while(d>Math.PI){start+=2*Math.PI;d=end-start;}while(d<-Math.PI){end+=2*Math.PI;d=end-start;} // smaller arc
    ctx.save();ctx.scale(Z,Z);ctx.setLineDash([4/Z,3/Z]);ctx.lineWidth=1/Z;ctx.strokeStyle='#555';ctx.beginPath();ctx.arc(p.x,p.y,r,start,end);ctx.stroke();ctx.restore();
    const mid=start+d/2; const lx=(p.x+Math.cos(mid)*(r+10))*Z, ly=(p.y+Math.sin(mid)*(r+10))*Z; badge(lx,ly,interior(pm,p,pn).toFixed(1)+'Â°',false);}
}
function badge(x,y,t,h){const w=ctx.measureText(t).width+12,hh=18;ctx.fillStyle=h?'#c01717':'#d00';ctx.beginPath();roundRect(x-w/2,y-hh/2,w,hh,9);ctx.fill();ctx.fillStyle='#fff';ctx.fillText(t,x-w/2+6,y+4);}
function roundRect(x,y,w,h,r){ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);}
draw();
</script>