<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>MR Flashing v6 ‚Äì Matrix Roofing</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#C11">
<style>
*{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#111}
.appbar{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid #e7e9ec;background:#fff}
.brand{font-weight:800;letter-spacing:.2px} .caps{text-transform:uppercase;letter-spacing:.08em;font-size:12px;color:#777}
.btn{border:1px solid #cfd6dd;background:#fff;padding:8px 10px;border-radius:8px} .btn.primary{background:#C11;color:#fff;border-color:#C11}
.layout{display:grid;grid-template-columns:56px 1fr 320px;grid-template-rows:auto 1fr auto;min-height:calc(100vh - 52px)}
.toolbar-vert{grid-row:1 / span 3;border-right:1px solid #e7e9ec;background:#121212;color:#eee;display:flex;flex-direction:column;align-items:center;padding:8px;gap:10px}
.tool{width:40px;height:40px;border-radius:10px;background:#1e1e1e;border:1px solid #2a2a2a;color:#eee;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer}
.tool:active{transform:scale(.98)} .tool.red{background:#C11;border-color:#C11}
.stage{position:relative;background:
 linear-gradient(0deg, rgba(0,0,0,.06) 1px, transparent 1px),
 linear-gradient(90deg, rgba(0,0,0,.06) 1px, transparent 1px);
 background-size:24px 24px}
#cv{border:1px solid #aeb6bf;background:#fff;margin:12px;touch-action:none;max-width:100%}
.inline-input{position:absolute;z-index:10;transform:translate(-50%,-50%)}
.inline-input input{padding:6px 8px;font-size:14px;border:2px solid #d00;border-radius:8px;min-width:90px;text-align:center}
.side{border-left:1px solid #e7e9ec;padding:10px} label{display:flex;flex-direction:column;gap:4px;font-size:12px;margin-bottom:8px}
input,select{padding:8px;border:1px solid #cfd6dd;border-radius:8px;width:100%}
.swatch{width:100%;height:28px;border:1px solid #cfd6dd;border-radius:8px;margin-top:6px}
.badge{background:#d00;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px}
.table{width:100%;border-collapse:collapse} .table th,.table td{border:1px solid #e1e5ea;padding:8px;font-size:13px} .table th{background:#f7f9fb;text-align:left}
.footer{padding:10px;border-top:1px solid #e7e9ec;background:#fafbfc;color:#4b4f56;font-size:12px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
.card{background:#fff;border-radius:12px;min-width:320px;max-width:90vw;padding:16px;border:1px solid #e7e9ec}
.row{display:flex;gap:8px;align-items:center} .row>*{flex:1} .row .shrink{flex:0 0 auto}
</style></head>
<body>
<header class="appbar">
  <div class="brand">MATRIX ROOFING</div><div class="caps">MR Flashing v6</div>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="actNew" class="btn">New</button>
    <button id="actSave" class="btn">Save</button>
    <button id="actLoad" class="btn">Load</button>
    <button id="actExport" class="btn">Export PDF</button>
    <button id="actShare" class="btn">Share Link</button>
    <button id="actAdd" class="btn primary">Add to Order</button>
  </div>
</header>

<div class="layout">
  <div></div>
  <main class="stage"><canvas id="cv" width="1280" height="720"></canvas><div id="overlay"></div></main>
  <aside class="toolbar-vert">
    <div class="tool" id="toolGrid" title="Grid Menu">‚â°</div>
    <div class="tool" id="toolBreak" title="Break Line">/</div>
    <div class="tool" id="toolComment" title="Comment">‚úö</div>
    <div class="tool" id="toolEndFolds" title="End Folds">‚Ñì</div>
    <div class="tool" id="toolColour" title="Colour">üé®</div>
    <div class="tool" id="toolSelect" title="Select">‚òùÔ∏é</div>
    <div class="tool red" id="toolUndo" title="Undo">‚ü≤</div>
  </aside>
</div>

<section class="side">
  <div class="row">
    <label style="margin:0;flex:1">Colourbond
      <select id="colour">
<option value='#ECEBE6' data-url='https://colorbond.com/products/colour/surfmist'>Surfmist</option>
<option value='#D6D0BE' data-url='https://colorbond.com/products/colour/evening-haze'>Evening Haze</option>
<option value='#F4E3BE' data-url='https://colorbond.com/products/colour/classic-cream'>Classic Cream</option>
<option value='#CBB99E' data-url='https://colorbond.com/products/colour/paperbark'>Paperbark</option>
<option value='#B7B9B7' data-url='https://colorbond.com/products/colour/shale-grey'>Shale Grey</option>
<option value='#B3ADA0' data-url='https://colorbond.com/products/colour/dune'>Dune</option>
<option value='#918A78' data-url='https://colorbond.com/products/colour/cove'>Cove</option>
<option value='#5E6D57' data-url='https://colorbond.com/products/colour/pale-eucalypt'>Pale Eucalypt</option>
<option value='#4B4F46' data-url='https://colorbond.com/products/colour/woodland-grey'>Woodland Grey</option>
<option value='#8F9697' data-url='https://colorbond.com/products/colour/windspray'>Windspray</option>
<option value='#7E726B' data-url='https://colorbond.com/products/colour/gully'>Gully</option>
<option value='#6E6F5B' data-url='https://colorbond.com/products/colour/mangrove'>Mangrove</option>
<option value='#2F3A56' data-url='https://colorbond.com/products/colour/deep-ocean'>Deep Ocean</option>
<option value='#2B5C4B' data-url='https://colorbond.com/products/colour/cottage-green'>Cottage Green</option>
<option value='#8C867B' data-url='https://colorbond.com/products/colour/wallaby'>Wallaby</option>
<option value='#7C5A46' data-url='https://colorbond.com/products/colour/jasper'>Jasper</option>
<option value='#6A6C6E' data-url='https://colorbond.com/products/colour/basalt'>Basalt</option>
<option value='#7E2B2B' data-url='https://colorbond.com/products/colour/manor-red'>Manor Red</option>
<option value='#1A1A1A' data-url='https://colorbond.com/products/colour/night-sky'>Night Sky</option>
<option value='#434E5A' data-url='https://colorbond.com/products/colour/ironstone'>Ironstone</option>
<option value='#7A4A3B' data-url='https://colorbond.com/products/colour/terrain'>Terrain</option>
<option value='#2B2B2B' data-url='https://colorbond.com/products/colour/monument'>Monument</option>
      </select>
      <div id="swatch" class="swatch"></div>
    </label>
    <button id="colourInfo" class="btn shrink">Info</button>
    <label class="shrink" style="min-width:120px">Face
      <select id="face"><option value="left">Left</option><option value="right">Right</option></select>
    </label>
  </div>
  <div class="row">
    <label>Zoom<input id="zoom" type="range" min="0.6" max="3" step="0.1" value="1"></label>
    <label>Scale (px/mm)<input id="scale" type="number" step="0.1" value="1"></label>
    <label>Snap (px)<input id="snap" type="number" value="6"></label>
    <button id="lock" class="btn shrink">üîí Lock</button>
  </div>
  <div class="row">
    <label>Seg #<input id="seg" type="number" value="0" min="0"></label>
    <label>Length (mm)<input id="segLen" type="number" value="0"></label>
    <label>Angle (¬∞)<input id="segAng" type="number" value="0" step="0.1"></label>
    <button id="apply" class="btn shrink">Apply</button>
  </div>
  <div class="row">
    <label>Name<input id="name" value="Flashing"></label>
    <label>Length (mm)<input id="lenmm" type="number" value="2400"></label>
    <label>Gauge<input id="gauge" value="0.55"></label>
    <label>Qty<input id="qty" type="number" value="1" min="1"></label>
  </div>
  <div style="display:flex;align-items:center;gap:8px;margin:8px 0">
    <button id="exportOrders" class="btn">Export Orders PDF</button>
    <button id="emailOrders" class="btn">Email Order</button>
    <button id="clearOrders" class="btn">Clear</button>
    <div style="margin-left:auto">Total items: <span id="orderCount">0</span></div>
  </div>
  <div style="overflow:auto">
    <table class="table" id="orderTable">
      <thead><tr><th>Preview</th><th>Name</th><th>Colour</th><th>Gauge</th><th>F</th><th>GIRTH</th><th>Q √ó L</th><th>T-Value</th><th>Notes</th><th>Actions</th></tr></thead>
      <tbody id="orderBody"></tbody>
    </table>
  </div>
</section>

<footer class="footer">Matrix Roofing ‚Äî Roof Restorations & Custom Flashings ¬∑ Melbourne VIC ¬∑ 1300 980 779 ¬∑ www.matrixroofing.com.au</footer>

<div class="modal" id="gridModal">
  <div class="card">
    <h3 style="margin:0 0 8px">Grid & Snapping</h3>
    <div class="row">
      <label>Grid size (px)<input id="gridSize" type="number" value="24"></label>
      <label>Snap (px)<input id="modalSnap" type="number" value="6"></label>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn" id="gridCancel">Cancel</button>
      <button class="btn primary" id="gridApply">Apply</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const cv=document.getElementById('cv'),ctx=cv.getContext('2d'),overlay=document.getElementById('overlay');
let Z=1,pxPerMm=1,snap=6,locked=false,drawing=false,lastTap=0,grid=24;let path=[],history=[],redo=[],mode='draw',comments=[],endFolds={start:false,end:false};
const colourSel=document.getElementById('colour'),faceSel=document.getElementById('face'),swatch=document.getElementById('swatch');
function updateGridBackground(){document.querySelector('.stage').style.backgroundSize = grid+'px '+grid+'px';} updateGridBackground();
function updateSwatch(){swatch.style.background = colourSel.value;} updateSwatch(); colourSel.onchange=updateSwatch;
document.getElementById('colourInfo').onclick=()=>{const opt=colourSel.options[colourSel.selectedIndex];const url=opt?.dataset?.url||''; if(url) window.open(url,'_blank');};
function push(){history.push(JSON.stringify({path,comments,endFolds})); if(history.length>200)history.shift(); redo.length=0;}
function undo(){if(history.length){redo.push(JSON.stringify({path,comments,endFolds}));const s=JSON.parse(history.pop());path=s.path||[];comments=s.comments||[];endFolds=s.endFolds||{start:false,end:false};draw();}}
function redoF(){if(redo.length){history.push(JSON.stringify({path,comments,endFolds}));const s=JSON.parse(redo.pop());path=s.path||[];comments=s.comments||[];endFolds=s.endFolds||{start:false,end:false};draw();}}
document.getElementById('toolUndo').onclick=undo;
document.getElementById('zoom').oninput=e=>{Z=parseFloat(e.target.value||'1');draw()};
document.getElementById('scale').onchange=e=>{pxPerMm=parseFloat(e.target.value||'1');draw()};
document.getElementById('snap').onchange=e=>{snap=parseInt(e.target.value||'0')};
document.getElementById('lock').onclick=()=>{locked=!locked;document.getElementById('lock').textContent=locked?'üîì Unlock':'üîí Lock'};
document.getElementById('toolGrid').onclick=()=>{document.getElementById('gridModal').style.display='flex';document.getElementById('gridSize').value=grid;document.getElementById('modalSnap').value=snap;};
document.getElementById('gridCancel').onclick=()=>document.getElementById('gridModal').style.display='none';
document.getElementById('gridApply').onclick=()=>{grid=parseInt(document.getElementById('gridSize').value||'24');snap=parseInt(document.getElementById('modalSnap').value||'6');updateGridBackground();document.getElementById('gridModal').style.display='none';};
document.getElementById('toolBreak').onclick=()=>{mode='break'};
document.getElementById('toolComment').onclick=()=>{mode='comment'};
document.getElementById('toolEndFolds').onclick=()=>{push();endFolds.start=!endFolds.start;endFolds.end=!endFolds.end;draw();};
document.getElementById('toolColour').onclick=()=>{colourSel.focus();colourSel.click();};
document.getElementById('toolSelect').onclick=()=>{mode='select'};

function pos(e){const r=cv.getBoundingClientRect();const x=((e.touches?e.touches[0].clientX:e.clientX)-r.left)/Z;const y=((e.touches?e.touches[0].clientY:e.clientY)-r.top)/Z;return{x,y}}
function snapP(p){if(!snap) return p; return {x:Math.round(p.x*snap)/snap, y:Math.round(p.y*snap)/snap}}
function down(e){const p=pos(e);const now=Date.now();const sp=snapP(p);
  if(locked){pickAtScreen({x:p.x*Z,y:p.y*Z});e.preventDefault();return;}
  if(mode==='break'){push();breakAtScreen({x:p.x*Z,y:p.y*Z});mode='draw';e.preventDefault();return;}
  if(mode==='comment'){const txt=prompt('Comment text?'); if(txt){comments.push({x:sp.x,y:sp.y,text:txt}); push(); draw();} mode='draw'; e.preventDefault(); return;}
  if(mode==='select'){pickAtScreen({x:p.x*Z,y:p.y*Z}); e.preventDefault(); return;}
  if(now-lastTap<300){drawing=false;} lastTap=now;
  if(!drawing){push(); path=[sp]; drawing=true;} else {push(); path.push(sp);}
  draw(); e.preventDefault();
}
function move(e){if(!drawing||!path.length||locked) return; path[path.length-1]=snapP(pos(e)); draw(); e.preventDefault();}
function up(e){e.preventDefault();}
cv.addEventListener('pointerdown',down,{passive:false});cv.addEventListener('pointermove',move,{passive:false});cv.addEventListener('pointerup',up,{passive:false});
cv.addEventListener('touchstart',down,{passive:false});cv.addEventListener('touchmove',move,{passive:false});cv.addEventListener('touchend',up,{passive:false});
cv.addEventListener('mousedown',down);cv.addEventListener('mousemove',move);['mouseup','mouseleave'].forEach(ev=>cv.addEventListener(ev,up));

function segs(){const s=[]; for(let i=0;i<path.length-1;i++) s.push([path[i],path[i+1],i]); return s;}
function normal(ax,ay,bx,by){const dx=bx-ax,dy=by-ay; const L=Math.hypot(dx,dy)||1; return{x:-dy/L,y:dx/L}}
function cornerAngle(prev,pt,next){const v1={x:prev.x-pt.x,y:prev.y-pt.y}, v2={x:next.x-pt.x,y:next.y-pt.y}; const dot=v1.x*v2.x+v1.y*v2.y, l1=Math.hypot(v1.x,v1.y), l2=Math.hypot(v2.x,v2.y); if(l1*l2===0) return 0; let ang=Math.acos(Math.max(-1,Math.min(1,dot/(l1*l2)))); return +(Math.min(ang*180/Math.PI,180)).toFixed(1) }
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);}
function drawBadge(cx,cy,text){ctx.font='12px system-ui,-apple-system'; const w=ctx.measureText(text).width+12, h=18; ctx.fillStyle='#d00'; roundRect(ctx,cx-w/2, cy-h/2, w, h, 9); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(text, cx - w/2 + 6, cy + 4); }

function draw(){ctx.clearRect(0,0,cv.width,cv.height); if(!path.length){drawComments(); return;} ctx.save(); ctx.scale(Z,Z);
  ctx.strokeStyle='#000'; ctx.lineWidth=2/Z; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x,path[i].y); ctx.stroke();
  if(endFolds.start && path.length>1){const a=path[0], b=path[1]; const n=normal(a.x,a.y,b.x,b.y); const off=6; ctx.strokeStyle='#000'; ctx.lineWidth=1/Z; ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(a.x + n.x*off, a.y + n.y*off); ctx.stroke(); }
  if(endFolds.end && path.length>1){const a=path[path.length-2], b=path[path.length-1]; const n=normal(a.x,a.y,b.x,b.y); const off=6; ctx.strokeStyle='#000'; ctx.lineWidth=1/Z; ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x + n.x*off, b.y + n.y*off); ctx.stroke(); }
  const face=faceSel.value, hex=colourSel.value; ctx.strokeStyle=hex; ctx.lineWidth=6/Z; ctx.globalAlpha=.35;
  for(let i=0;i<path.length-1;i++){const a=path[i],b=path[i+1];const n=normal(a.x,a.y,b.x,b.y);const off=face==='left'?6:-6; ctx.beginPath(); ctx.moveTo(a.x+n.x*off, a.y+n.y*off); ctx.lineTo(b.x+n.x*off, b.y+n.y*off); ctx.stroke(); } ctx.globalAlpha=1;
  ctx.fillStyle='#000'; for(const p of path){ctx.beginPath(); ctx.arc(p.x,p.y,3/Z,0,Math.PI*2); ctx.fill(); }
  const r=20; ctx.strokeStyle='#555'; ctx.lineWidth=1/Z; ctx.setLineDash([4/Z,3/Z]);
  for(let i=1;i<path.length-1;i++){const pm=path[i-1], p=path[i], pn=path[i+1]; let a1=Math.atan2(pm.y-p.y, pm.x-p.x), a2=Math.atan2(pn.y-p.y, pn.x-p.x); let diff=a2-a1; while(diff>Math.PI){a2-=2*Math.PI; diff=a2-a1} while(diff<-Math.PI){a2+=2*Math.PI; diff=a2-a1} ctx.beginPath(); ctx.arc(p.x,p.y,r,a1,a2); ctx.stroke(); }
  ctx.setLineDash([]); ctx.restore();
  for(let i=0;i<path.length-1;i++){const a=path[i],b=path[i+1]; const L=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; const midx=(a.x+b.x)/2*Z, midy=(a.y+b.y)/2*Z; drawBadge(midx, midy, Math.round(L)+''); }
  for(let i=1;i<path.length-1;i++){const ang=cornerAngle(path[i-1],path[i],path[i+1]); const bx=path[i].x*Z+8, by=path[i].y*Z-8; drawBadge(bx, by, ang+'¬∞'); }
  drawComments();
}
function drawComments(){if(!comments.length) return; ctx.save(); ctx.font='12px system-ui,-apple-system'; ctx.fillStyle='#111'; comments.forEach(c=>{ctx.fillText('‚úé '+c.text, c.x*Z+6, c.y*Z-6);}); ctx.restore(); }
function clearInline(){overlay.innerHTML=''};
function showInline(x,y,value,onEnter){clearInline(); const w=document.createElement('div'); w.className='inline-input'; w.style.left=x+'px'; w.style.top=y+'px'; const inp=document.createElement('input'); inp.value=value; w.appendChild(inp); overlay.appendChild(w); inp.focus(); inp.select(); inp.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ onEnter(parseFloat(inp.value)); clearInline(); draw(); } if(ev.key==='Escape'){ clearInline(); draw(); } }); }
function pickAtScreen(sp){let bestKind=null,bestIndex=-1,bestd=1e9,bestPt=null; segs().forEach(([a,b,i])=>{const midx=(a.x+b.x)/2*Z, midy=(a.y+b.y)/2*Z; const d=Math.hypot(sp.x-midx, sp.y-midy); if(d<bestd){bestd=d; bestKind='seg'; bestIndex=i; bestPt={x:midx,y:midy};}}); for(let i=1;i<path.length-1;i++){const p=path[i]; const bx=p.x*Z+8, by=p.y*Z-8; const d=Math.hypot(sp.x-bx, sp.y-by); if(d<bestd){bestd=d; bestKind='corner'; bestIndex=i; bestPt={x:bx,y:by};}} if(bestd<40){ if(bestKind==='seg'){ const a=path[bestIndex], b=path[bestIndex+1]; const dx=b.x-a.x, dy=b.y-a.y; const lengthMm=(Math.hypot(dx,dy)/pxPerMm); showInline(bestPt.x, bestPt.y, Math.round(lengthMm), (newLen)=>{ const ang=Math.atan2(-dy, dx); const L=(newLen||0)*pxPerMm; path[bestIndex+1]={x:a.x+L*Math.cos(ang), y:a.y-L*Math.sin(ang)}; }); } else { const ang=cornerAngle(path[bestIndex-1],path[bestIndex],path[bestIndex+1]); showInline(bestPt.x, bestPt.y, ang, (newAng)=>{ applyCorner(bestIndex, parseFloat(newAng||ang)); }); } }}
function applyCorner(i,desiredDeg){ if(path.length<3) return; i=Math.max(1, Math.min(i, path.length-2)); const desired=Math.max(0, Math.min(180, desiredDeg))*Math.PI/180; const Pm=path[i-1], P=path[i], Pn=path[i+1]; const vPrev={x:P.x-Pm.x, y:P.y-Pm.y}; const thetaPrev=Math.atan2(vPrev.y, vPrev.x); const delta = Math.PI - desired; const cur=Math.atan2(Pn.y-P.y, Pn.x-P.x); const opt1=thetaPrev+delta, opt2=thetaPrev-delta; const d1=Math.abs(Math.atan2(Math.sin(cur-opt1), Math.cos(cur-opt1))); const d2=Math.abs(Math.atan2(Math.sin(cur-opt2), Math.cos(cur-opt2))); const theta=d1<=d2?opt1:opt2; const L=Math.hypot(Pn.x-P.x, Pn.y-P.y); path[i+1]={x:P.x+L*Math.cos(theta), y:P.y+L*Math.sin(theta)}; draw(); }
function breakAtScreen(sp){ if(path.length<2) return; let bestIndex=-1, bestDist=1e9; segs().forEach(([a,b,i])=>{ const mx=(a.x+b.x)/2*Z, my=(a.y+b.y)/2*Z; const d=Math.hypot(sp.x-mx, sp.y-my); if(d<bestDist){ bestDist=d; bestIndex=i; } }); if(bestIndex<0) return; const a=path[bestIndex], b=path[bestIndex+1]; const mid={x:(a.x+b.x)/2, y:(a.y+b.y)/2}; path.splice(bestIndex+1,0,mid); draw(); }
document.getElementById('apply').onclick=()=>{ const S=segs(); if(!S.length) return; let i=Math.min(parseInt(document.getElementById('seg').value||'0'), S.length-1); const a=path[i]; const L=(parseFloat(document.getElementById('segLen').value)||0)*pxPerMm; const ang=(parseFloat(document.getElementById('segAng').value)||0)*Math.PI/180; path[i+1]={x:a.x+L*Math.cos(ang), y:a.y-L*Math.sin(ang)}; draw(); };
function snapshot(){ return cv.toDataURL('image/png'); } function foldCount(){ return Math.max(0, path.length-1) + (endFolds.start?1:0) + (endFolds.end?1:0); }
function girth(){ let g=0; for(let i=0;i<path.length-1;i++){ const a=path[i],b=path[i+1]; g+=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; } if(endFolds.start) g+=10; if(endFolds.end) g+=10; return Math.round(g); }
const orders=[];
function addToOrder(){ if(path.length<2){ alert('Draw first'); return; } const item={ id:Date.now().toString(), name:document.getElementById('name').value||'Flashing', qty:parseInt(document.getElementById('qty').value||'1'), length_mm:parseInt(document.getElementById('lenmm').value||'0'), gauge:document.getElementById('gauge').value||'0.55', colourName:colourSel.options[colourSel.selectedIndex]?.text||'Colour', colourHex:colourSel.value, face:faceSel.value, F:foldCount(), GIRTH:girth(), T:(girth()/1000).toFixed(1), image:snapshot(), path, pxPerMm, endFolds }; orders.unshift(item); renderOrders(); }
function renderOrders(){ const body=document.getElementById('orderBody'); body.innerHTML=''; document.getElementById('orderCount').textContent=String(orders.length); orders.forEach((o,idx)=>{ const tr=document.createElement('tr'); tr.innerHTML='<td><img src="'+o.image+'" style="width:120px;height:auto;border:1px solid #ddd;border-radius:6px"></td><td>'+o.name+'</td><td>'+o.colourName+'</td><td>'+o.gauge+'</td><td>'+o.F+'</td><td>'+o.GIRTH+'</td><td>'+o.qty+' √ó '+o.length_mm+'</td><td>'+o.T+'</td><td contenteditable="true"></td><td><button data-i="'+idx+'" class="btn">Remove</button></td>'; body.appendChild(tr); }); body.querySelectorAll('button.btn').forEach(btn=>btn.onclick=(ev)=>{ const i=parseInt(btn.getAttribute('data-i')); orders.splice(i,1); renderOrders(); }); }
document.getElementById('actAdd').onclick=addToOrder; document.getElementById('clearOrders').onclick=()=>{ orders.length=0; renderOrders(); };
document.getElementById('emailOrders').onclick=()=>{ const lines=orders.map((o,i)=> (i+1)+'. '+o.name+' x'+o.qty+' ‚Äî '+o.length_mm+'mm, '+o.gauge+', '+o.colourName+' (F:'+o.F+' G:'+o.GIRTH+' T:'+o.T+')').join('%0D%0A'); location.href='mailto:?subject=MR Flashing Order&body='+encodeURIComponent('MR Flashing Order:')+'%0D%0A%0D%0A'+lines; };
document.getElementById('exportOrders').onclick=()=>{ if(!orders.length){ alert('No items'); return; } const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt', format:'a4'}); let y=40; doc.setFontSize(14); doc.setTextColor(193,17,17); doc.text('MATRIX ROOFING ‚Äî MR FLASHING ORDER', 40, y); y+=24; doc.setTextColor(0,0,0); doc.setFontSize(10); const dt=new Date().toLocaleString(); doc.text('Generated: '+dt, 40, y); y+=18; doc.setFontSize(9); function row(cells){ let x=40; const widths=[80,90,50,40,50,70,60,90]; for(let i=0;i<cells.length;i++){ doc.rect(x,y, widths[i], 20); doc.text(String(cells[i]), x+4, y+13); x+=widths[i]; } y+=20; } row(['Name','Colour','Gauge','F','GIRTH','Q √ó L','T-Value','Notes']); orders.forEach(o=> row([o.name,o.colourName,o.gauge,o.F,o.GIRTH, o.qty+' √ó '+o.length_mm, o.T, ''])); y+=20; doc.text('Matrix Roofing ‚Äî Roof Restorations & Custom Flashings ¬∑ Melbourne VIC ¬∑ 1300 980 779 ¬∑ www.matrixroofing.com.au', 40, y); doc.save('MR-Flashing-Order.pdf'); };
document.getElementById('actNew').onclick=()=>{ if(path.length>1 && !confirm('Clear current drawing?')) return; path=[]; comments=[]; history.length=0; redo.length=0; draw(); };
document.getElementById('actSave').onclick=()=>{ const d=currentDesign(); localStorage.setItem('mr-flashing-v6', JSON.stringify(d)); const blob=new Blob([JSON.stringify(d,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(d.item?.name||'design')+'.mrfl.json'; a.click(); };
document.getElementById('actLoad').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,.mrfl.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ applyDesign(JSON.parse(r.result)); }catch(e){ alert('Invalid file'); } }; r.readAsText(f); }; inp.click(); };
document.getElementById('actShare').onclick=()=>{ const enc=btoa(unescape(encodeURIComponent(JSON.stringify(currentDesign())))); const url=location.origin+location.pathname+'#d='+enc; navigator.clipboard?.writeText(url); alert('Share link copied to clipboard.'); };
function currentDesign(){ return { meta:{ app:'MR Flashing', version:'v6', brand:'Matrix Roofing', ts:Date.now() }, drawing:{ path, pxPerMm, Z, snap, grid, colourHex:colourSel.value, face:faceSel.value, endFolds }, item:{ name:document.getElementById('name').value, length_mm:parseInt(document.getElementById('lenmm').value||'0'), gauge:document.getElementById('gauge').value, qty:parseInt(document.getElementById('qty').value||'1') }, comments }; }
function applyDesign(d){ if(!d) return; path=d.drawing?.path||[]; pxPerMm=d.drawing?.pxPerMm||1; Z=d.drawing?.Z||1; snap=d.drawing?.snap||6; grid=d.drawing?.grid||24; endFolds=d.drawing?.endFolds||{start:false,end:false}; colourSel.value=d.drawing?.colourHex||colourSel.value; faceSel.value=d.drawing?.face||'left'; document.getElementById('zoom').value=Z; document.getElementById('scale').value=pxPerMm; document.getElementById('snap').value=snap; updateGridBackground(); document.getElementById('name').value=d.item?.name||'Flashing'; document.getElementById('lenmm').value=d.item?.length_mm||2400; document.getElementById('gauge').value=d.item?.gauge||'0.55'; document.getElementById('qty').value=d.item?.qty||1; comments=d.comments||[]; updateSwatch(); draw(); }
(function init(){ const hash=location.hash||''; if(hash.startsWith('#d=')){ try{ const dec=JSON.parse(decodeURIComponent(escape(atob(hash.slice(3))))); applyDesign(dec); return; }catch(e){} } const saved=localStorage.getItem('mr-flashing-v6'); if(saved){ try{ applyDesign(JSON.parse(saved)); }catch(e){} } draw(); })();
document.getElementById('actExport').onclick=()=>{ const { jsPDF } = window.jspdf; const doc = new jsPDF({unit:'pt', format:'a4'}); let y=40; doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text('PREVIEW ORDER', 40, y); y+=18; doc.setFontSize(10); doc.text('‚Ä¢ Arrow points to the (solid) coloured side', 40, y); y+=14; doc.text('‚Ä¢ 90¬∞ degrees are not labelled', 40, y); y+=14; doc.text('‚Ä¢ F = Total number of folds, each crush counts as 2 folds', 40, y); y+=20; doc.setFontSize(9); doc.rect(40, y, 520, 20); function hcell(x,w,txt){ doc.rect(x,y,w,20); doc.text(txt, x+6, y+13); } hcell(40,240,'Colour / Material'); hcell(280,60,'CODE'); hcell(340,60,'F'); hcell(400,60,'GIRTH'); y+=20; const colourName = colourSel.options[colourSel.selectedIndex]?.text || 'Colour'; const fcount = foldCount(); const g = girth(); doc.rect(40, y, 240, 20); doc.text(colourName, 46, y+13); doc.rect(280, y, 60, 20); doc.text('', 290, y+13); doc.rect(340, y, 60, 20); doc.text(String(fcount), 366, y+13); doc.rect(400, y, 60, 20); doc.text(String(g), 410, y+13); y+=26; const qty = document.getElementById('qty').value||'1'; const lenmm = document.getElementById('lenmm').value||'0'; doc.text('Q √ó L  '+qty+' √ó '+lenmm, 40, y); doc.text('T - '+(g/1000).toFixed(1), 300, y); y+=12; const img=cv.toDataURL('image/png'); doc.addImage(img,'PNG',40,y+6,380,220); y+=240; y+=10; doc.setFontSize(9); doc.text('Matrix Roofing ‚Äî Roof Restorations & Custom Flashings ¬∑ Melbourne VIC ¬∑ 1300 980 779 ¬∑ www.matrixroofing.com.au',40,y); doc.save('MR-Flashing-Design.pdf'); };
</script>
</body></html>
