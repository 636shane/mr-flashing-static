
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MR Flashing v5.8 â€” Matrix Roofing</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003A75">
<style>
:root{--brand:#003A75}
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.appbar{display:flex;gap:10px;align-items:center;padding:10px;border-bottom:1px solid #e8ecf0;background:#fff}
.logo{font-weight:800;color:var(--brand)}
.btn{border:1px solid #ccd3da;background:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
.panel{display:grid;grid-template-columns:320px 1fr;min-height:calc(100vh - 56px)}
.left{border-right:1px solid #e8ecf0;padding:10px}
label{font-size:12px;display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
input,select{padding:8px;border:1px solid #ccd3da;border-radius:8px;width:100%}
.swatch{width:100%;height:28px;border:1px solid #ccd3da;border-radius:8px;margin-top:6px}
.stage{position:relative;background:linear-gradient(0deg,rgba(0,0,0,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(0,0,0,.06) 1px,transparent 1px);background-size:24px 24px;overflow:auto}
#cv{border:1px solid #b6c0ca;background:#fff;margin:16px;touch-action:none;max-width:100%}
.inline-input{position:absolute;z-index:10;transform:translate(-50%,-50%)}
.inline-input input{padding:6px 8px;font-size:14px;border:2px solid #d00;border-radius:8px;min-width:90px;text-align:center}
</style>
</head>
<body>
<div class="appbar">
  <div class="logo">MATRIX ROOFING</div><div>MR Flashing</div>
  <button id="new" class="btn">New</button>
  <button id="lock" class="btn">ðŸ”’ Lock</button>
  <button id="undo" class="btn">â†©ï¸Ž Undo</button>
  <button id="redo" class="btn">â†ªï¸Ž Redo</button>
  <button id="dot" class="btn primary">Dot Mode: ON</button>
  <div style="margin-left:auto"></div>
  <button id="exportPNG" class="btn">Export PNG</button>
</div>
<div class="panel">
  <div class="left">
    <label>Zoom <input id="zoom" type="range" min="0.5" max="3" step="0.1" value="1"></label>
    <label>Scale (px/mm) <input id="scale" type="number" step="0.1" value="1"></label>
    <label>Snap (px) <input id="snap" type="number" value="6"></label>
    <label>Colourbond
      <select id="colour">
  <option value="#ECEBE6">Surfmist</option>
  <option value="#D6D0BE">Evening Haze</option>
  <option value="#F4E3BE">Classic Cream</option>
  <option value="#CBB99E">Paperbark</option>
  <option value="#B7B9B7">Shale Grey</option>
  <option value="#B3ADA0">Dune</option>
  <option value="#918A78">Cove</option>
  <option value="#5E6D57">Pale Eucalypt</option>
  <option value="#4B4F46">Woodland Grey</option>
  <option value="#8F9697">Windspray</option>
  <option value="#7E726B">Gully</option>
  <option value="#6E6F5B">Mangrove</option>
  <option value="#2F3A56">Deep Ocean</option>
  <option value="#2B5C4B">Cottage Green</option>
  <option value="#8C867B">Wallaby</option>
  <option value="#7C5A46">Jasper</option>
  <option value="#6A6C6E">Basalt</option>
  <option value="#7E2B2B">Manor Red</option>
  <option value="#1A1A1A">Night Sky</option>
  <option value="#434E5A">Ironstone</option>
  <option value="#7A4A3B">Terrain</option>
  <option value="#2B2B2B">Monument</option>
</select>
      <div id="swatch" class="swatch"></div>
    </label>
    <label>Face
      <select id="face"><option value="left">Left</option><option value="right">Right</option></select>
    </label>
  </div>
  <div class="stage">
    <canvas id="cv" width="1200" height="700"></canvas>
    <div id="overlay"></div>
  </div>
</div>
<script>
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
const overlay=document.getElementById('overlay');
const colourSel=document.getElementById('colour'), swatch=document.getElementById('swatch');
swatch.style.background=colourSel.value; colourSel.onchange=()=>swatch.style.background=colourSel.value;
const faceSel=document.getElementById('face');

let Z=1, pxPerMm=1, snap=6, locked=false;
let path=[], history=[], redoStack=[], dotMode=true, hoverPos=null;

// helpers
function push(){history.push(JSON.stringify(path)); if(history.length>200)history.shift(); redoStack.length=0;}
function undo(){if(history.length){redoStack.push(JSON.stringify(path)); path=JSON.parse(history.pop()); draw();}}
function redo(){if(redoStack.length){history.push(JSON.stringify(path)); path=JSON.parse(redoStack.pop()); draw();}}
function pos(e){const r=cv.getBoundingClientRect(); const x=((e.touches?e.touches[0].clientX:e.clientX)-r.left)/Z; const y=((e.touches?e.touches[0].clientY:e.clientY)-r.top)/Z; return {x,y};}
function snapP(p){if(!snap)return p; return {x:Math.round(p.x*snap)/snap,y:Math.round(p.y*snap)/snap};}
function segs(){const s=[]; for(let i=0;i<path.length-1;i++) s.push([path[i],path[i+1],i]); return s;}
function normal(ax,ay,bx,by){const dx=bx-ax,dy=by-ay; const L=Math.hypot(dx,dy)||1; return {x:-dy/L,y:dx/L};}
function cornerAngle(prev,pt,next){const v1={x:prev.x-pt.x,y:prev.y-pt.y}, v2={x:next.x-pt.x,y:next.y-pt.y}; const dot=v1.x*v2.x+v1.y*v2.y, l1=Math.hypot(v1.x,v1.y), l2=Math.hypot(v2.x,v2.y); if(l1*l2===0)return 0; let ang=Math.acos(Math.max(-1,Math.min(1,dot/(l1*l2)))); return +(Math.min(ang*180/Math.PI,180)).toFixed(1);}
function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);}
function drawBadge(x,y,text){ctx.font='12px system-ui,-apple-system'; const w=ctx.measureText(text).width+12,h=18; ctx.fillStyle='#d00'; roundRect(ctx,x-w/2,y-h/2,w,h,9); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(text,x-w/2+6,y+4);}

// draw
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  if(!path.length) return;
  ctx.save(); ctx.scale(Z,Z);
  ctx.strokeStyle='#000'; ctx.lineWidth=2/Z; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x,path[i].y); ctx.stroke();
  ctx.globalAlpha=.35; ctx.strokeStyle=colourSel.value; ctx.lineWidth=6/Z;
  for(let i=0;i<path.length-1;i++){const a=path[i],b=path[i+1]; const n=normal(a.x,a.y,b.x,b.y); const off=faceSel.value==='left'?6:-6; ctx.beginPath(); ctx.moveTo(a.x+n.x*off,a.y+n.y*off); ctx.lineTo(b.x+n.x*off,b.y+n.y*off); ctx.stroke();}
  ctx.globalAlpha=1;
  ctx.fillStyle='#000'; for(const p of path){ctx.beginPath(); ctx.arc(p.x,p.y,3/Z,0,Math.PI*2); ctx.fill();}
  const r=20; ctx.strokeStyle='#666'; ctx.setLineDash([4/Z,3/Z]); ctx.lineWidth=1/Z;
  for(let i=1;i<path.length-1;i++){const pm=path[i-1],p=path[i],pn=path[i+1]; let a1=Math.atan2(pm.y-p.y,pm.x-p.x), a2=Math.atan2(pn.y-p.y,pn.x-p.x); let d=a2-a1; while(d>Math.PI){a2-=2*Math.PI; d=a2-a1;} while(d<-Math.PI){a2+=2*Math.PI; d=a2-a1;} ctx.beginPath(); ctx.arc(p.x,p.y,r,a1,a2); ctx.stroke();}
  ctx.setLineDash([]); ctx.restore();
  for(let i=0;i<path.length-1;i++){const a=path[i],b=path[i+1]; const L=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; drawBadge(((a.x+b.x)/2)*Z,((a.y+b.y)/2)*Z,Math.round(L)+' mm');}
  for(let i=1;i<path.length-1;i++){const ang=cornerAngle(path[i-1],path[i],path[i+1]); drawBadge(path[i].x*Z+10,path[i].y*Z-10,ang+'Â°');}
  if(dotMode && hoverPos && path.length && !locked){ ctx.save(); ctx.scale(Z,Z); const a=path[path.length-1], b=snapP(hoverPos); ctx.setLineDash([6/Z,6/Z]); ctx.lineWidth=1.5/Z; ctx.strokeStyle='#888'; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); ctx.restore(); }
}
// inline editor
function clearInline(){overlay.innerHTML='';}
function showInline(x,y,value,onEnter){clearInline(); const w=document.createElement('div'); w.className='inline-input'; w.style.left=x+'px'; w.style.top=y+'px'; const inp=document.createElement('input'); inp.type='number'; inp.value=value; w.appendChild(inp); overlay.appendChild(w); inp.focus(); inp.select(); inp.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ onEnter(parseFloat(inp.value)); clearInline(); draw(); } if(ev.key==='Escape'){ clearInline(); draw(); } });}
function pickAtScreen(sp){let bestKind=null,bestIndex=-1,bestd=1e9,bx=0,by=0;
  segs().forEach(([a,b,i])=>{const mx=(a.x+b.x)/2*Z,my=(a.y+b.y)/2*Z; const d=Math.hypot(sp.x-mx,sp.y-my); if(d<bestd){bestd=d;bestKind='seg';bestIndex=i;bx=mx;by=my;}});
  for(let i=1;i<path.length-1;i++){const px=path[i].x*Z+10,py=path[i].y*Z-10; const d=Math.hypot(sp.x-px,sp.y-py); if(d<bestd){bestd=d;bestKind='corner';bestIndex=i;bx=px;by=py;}}
  if(bestd>48) return;
  if(bestKind==='seg'){const a=path[bestIndex],b=path[bestIndex+1]; const dx=b.x-a.x,dy=b.y-a.y; const len=Math.hypot(dx,dy)/pxPerMm; showInline(bx,by,Math.round(len),(newLen)=>{const ang=Math.atan2(-dy,dx); const m=(newLen||0)*pxPerMm; path[bestIndex+1]={x:a.x+m*Math.cos(ang), y:a.y-m*Math.sin(ang)}; draw();});}
  else{const ang=cornerAngle(path[bestIndex-1],path[bestIndex],path[bestIndex+1]); showInline(bx,by,ang,(newAng)=>applyCorner(bestIndex,parseFloat(newAng||ang)));}
}
function applyCorner(i,deg){if(path.length<3)return; i=Math.max(1,Math.min(i,path.length-2)); const desired=Math.max(0,Math.min(180,deg))*Math.PI/180; const Pm=path[i-1],P=path[i],Pn=path[i+1]; const vPrev={x:P.x-Pm.x,y:P.y-Pm.y}, thetaPrev=Math.atan2(vPrev.y,vPrev.x); const delta=Math.PI-desired; const cur=Math.atan2(Pn.y-P.y,Pn.x-P.x); const wrap=t=>Math.atan2(Math.sin(t),Math.cos(t)); const opt1=thetaPrev+delta,opt2=thetaPrev-delta; const theta=(Math.abs(wrap(cur-opt1))<=Math.abs(wrap(cur-opt2)))?opt1:opt2; const L=Math.hypot(Pn.x-P.x,Pn.y-P.y); path[i+1]={x:P.x+L*Math.cos(theta), y:P.y+L*Math.sin(theta)}; draw();}

// events
function onDown(e){const p=pos(e); const sp=snapP(p); if(locked){pickAtScreen({x:p.x*Z,y:p.y*Z}); e.preventDefault(); return;}
  if(dotMode){ if(!path.length){push(); path=[sp];} else{push(); path.push(sp);} draw(); e.preventDefault(); return; }
  push(); path=[sp]; cv.onpointermove=ev=>{ path[path.length-1]=snapP(pos(ev)); draw(); }; e.preventDefault();
}
function onMove(e){hoverPos=pos(e); draw();}
function onUp(e){cv.onpointermove=null;}
cv.addEventListener('pointerdown',onDown,{passive:false});
cv.addEventListener('pointermove',onMove,{passive:false});
cv.addEventListener('pointerup',onUp,{passive:false});

// controls
document.getElementById('new').onclick=()=>{ if(path.length>1 && !confirm('Clear drawing?'))return; path=[]; history.length=0; redoStack.length=0; draw(); };
document.getElementById('lock').onclick=()=>{ locked=!locked; document.getElementById('lock').textContent=locked?'ðŸ”“ Unlock':'ðŸ”’ Lock'; };
document.getElementById('undo').onclick=undo; document.getElementById('redo').onclick=redo;
document.getElementById('dot').onclick=()=>{ dotMode=!dotMode; const b=document.getElementById('dot'); b.textContent='Dot Mode: '+(dotMode?'ON':'OFF'); b.classList.toggle('primary',dotMode); };
document.getElementById('zoom').oninput=e=>{ Z=parseFloat(e.target.value||'1'); draw(); };
document.getElementById('scale').onchange=e=>{ pxPerMm=parseFloat(e.target.value||'1'); draw(); };
document.getElementById('snap').onchange=e=>{ snap=parseInt(e.target.value||'0'); };
document.getElementById('exportPNG').onclick=()=>{ const a=document.createElement('a'); a.href=cv.toDataURL('image/png'); a.download='mr-flashing.png'; a.click(); };
draw();
</script>
</body>
</html>
