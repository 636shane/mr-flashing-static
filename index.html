<!doctype html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>MR Flashing v5.9 â€” Matrix Roofing</title>
<link rel='manifest' href='manifest.json'>
<meta name='theme-color' content='#003A75'>
<style>
*{box-sizing:border-box}body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
.appbar{display:flex;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid #e7e9ec;background:#fff}
.logo{font-weight:800;color:#003A75}.appname{font-weight:600}
.toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid #cfd6dd;background:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.btn.primary{background:#003A75;color:#fff;border-color:#003A75}
.wrapper{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr auto;min-height:calc(100vh - 48px)}
.sidebar{border-right:1px solid #e7e9ec;padding:10px;background:#fff}
.section{border-bottom:1px solid #eef1f4;padding-bottom:8px;margin-bottom:10px}
label{font-size:12px;color:#333;display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
input,select{padding:8px;border:1px solid #cfd6dd;border-radius:8px;width:100%}
.swatch{width:100%;height:28px;border:1px solid #cfd6dd;border-radius:8px;margin-top:6px}
.stage{position:relative;background:linear-gradient(0deg,rgba(0,0,0,.06) 1px,transparent 1px),linear-gradient(90deg,rgba(0,0,0,.06) 1px,transparent 1px);background-size:24px 24px;overflow:auto}
#cv{border:1px solid #aeb6bf;background:#fff;display:block;margin:16px;touch-action:none;max-width:100%}
.inline-input{position:absolute;z-index:10;transform:translate(-50%,-50%)}
.inline-input input{padding:6px 8px;font-size:14px;border:2px solid #d00;border-radius:8px;min-width:90px;text-align:center}
.footer{padding:12px;border-top:1px solid #e7e9ec;background:#fafbfc;color:#4b4f56;font-size:12px}
.orders{padding:10px;border-top:1px solid #e7e9ec;background:#fff}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #e1e5ea;padding:8px;font-size:13px;vertical-align:top}
.table th{background:#f7f9fb;text-align:left}
</style>
</head>
<body>
<header class='appbar'>
  <div class='logo'>MATRIX ROOFING</div><div class='appname'>MR Flashing v5.9</div>
  <div class='toolbar'>
    <button id='actNew' class='btn'>New</button>
    <button id='actSave' class='btn'>Save</button>
    <button id='actLoad' class='btn'>Load</button>
    <button id='actExport' class='btn'>Export PDF</button>
    <button id='actShare' class='btn'>Share Link</button>
    <button id='dotMode' class='btn'>Dot Mode: ON</button>
    <button id='actAdd' class='btn primary'>Add to Order</button>
  </div>
</header>

<div class='wrapper'>
  <aside class='sidebar'>
    <div class='section'>
      <label>Zoom<input id='zoom' type='range' min='0.5' max='3' step='0.1' value='1'></label>
      <label>Scale (px/mm)<input id='scale' type='number' step='0.1' value='1'></label>
      <label>Snap (px)<input id='snap' type='number' value='6'></label>
      <div style='display:flex;gap:8px'>
        <button id='lock' class='btn' style='flex:1'>ðŸ”’ Lock</button>
        <button id='undo' class='btn' style='flex:1'>â†©ï¸Ž Undo</button>
        <button id='redo' class='btn' style='flex:1'>â†ªï¸Ž Redo</button>
      </div>
    </div>

    <div class='section'>
      <label>Colourbond
        <select id='colour'>
          <option value='#ECEBE6'>Surfmist</option>
          <option value='#D6D0BE'>Evening Haze</option>
          <option value='#F4E3BE'>Classic Cream</option>
          <option value='#CBB99E'>Paperbark</option>
          <option value='#B7B9B7'>Shale Grey</option>
          <option value='#B3ADA0'>Dune</option>
          <option value='#918A78'>Cove</option>
          <option value='#5E6D57'>Pale Eucalypt</option>
          <option value='#4B4F46'>Woodland Grey</option>
          <option value='#8F9697'>Windspray</option>
          <option value='#7E726B'>Gully</option>
          <option value='#6E6F5B'>Mangrove</option>
          <option value='#2F3A56'>Deep Ocean</option>
          <option value='#2B5C4B'>Cottage Green</option>
          <option value='#8C867B'>Wallaby</option>
          <option value='#7C5A46'>Jasper</option>
          <option value='#6A6C6E'>Basalt</option>
          <option value='#7E2B2B'>Manor Red</option>
          <option value='#1A1A1A'>Night Sky</option>
          <option value='#434E5A'>Ironstone</option>
          <option value='#7A4A3B'>Terrain</option>
          <option value='#2B2B2B'>Monument</option>
        </select>
        <div id='swatch' class='swatch'></div>
      </label>
      <label>Face<select id='face'><option value='left'>Left</option><option value='right'>Right</option></select></label>
    </div>

    <div class='section'>
      <label>Seg #<input id='seg' type='number' value='0' min='0'></label>
      <label>Length (mm)<input id='segLen' type='number' value='0'></label>
      <label>Angle (Â°)<input id='segAng' type='number' value='0' step='0.1'></label>
      <button id='apply' class='btn'>Apply Segment</button>
    </div>

    <div class='section'>
      <label>Name<input id='name' value='Flashing'></label>
      <label>Length (mm)
        <div style='display:flex;gap:6px'>
          <button class='btn' id='lenDec' type='button' style='width:44px'>â€“</button>
          <input id='lenmm' type='number' value='2400' step='10' min='10' style='flex:1'>
          <button class='btn' id='lenInc' type='button' style='width:44px'>+</button>
        </div>
      </label>
      <label>Qty
        <div style='display:flex;gap:6px'>
          <button class='btn' id='qtyDec' type='button' style='width:44px'>â€“</button>
          <input id='qty' type='number' value='1' min='1' step='1' style='flex:1'>
          <button class='btn' id='qtyInc' type='button' style='width:44px'>+</button>
        </div>
      </label>
      <label>Gauge<input id='gauge' value='0.55'></label>
    </div>
  </aside>

  <main class='stage' id='stage'>
    <canvas id='cv' width='1280' height='720'></canvas>
    <div id='overlay'></div>
  </main>

  <section class='orders'>
    <div style='display:flex;align-items:center;gap:10px;margin-bottom:6px'>
      <strong>Orders</strong>
      <button id='exportOrders' class='btn'>Export Orders PDF</button>
      <button id='emailOrders' class='btn'>Email Order</button>
      <button id='clearOrders' class='btn'>Clear</button>
      <div style='margin-left:auto'>Total items: <span id='orderCount'>0</span></div>
    </div>
    <div style='overflow:auto'>
      <table class='table' id='orderTable'>
        <thead><tr>
          <th>Preview</th><th>Name</th><th>Colour</th><th>Gauge</th><th>F</th><th>GIRTH</th><th>Q Ã— L (mm)</th><th>T</th><th>Notes</th><th>Actions</th>
        </tr></thead>
        <tbody id='orderBody'></tbody>
      </table>
    </div>
  </section>
</div>

<footer class='footer'>Matrix Roofing â€” Roof Restorations & Custom Flashings Â· Melbourne VIC Â· 1300 980 779 Â· www.matrixroofing.com.au</footer>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'></script>
<script>
// --- core state ---
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
const overlay=document.getElementById('overlay');
let Z=1,pxPerMm=1,snap=6,locked=false,drawing=false;
let path=[],history=[],redoStack=[],dotMode=true,hoverPos=null;
const faceSel=document.getElementById('face'),colourSel=document.getElementById('colour');
const swatch=document.getElementById('swatch'); swatch.style.background=colourSel.value; colourSel.onchange=()=>swatch.style.background=colourSel.value;

// steppers
const lenEl=document.getElementById('lenmm'), qtyEl=document.getElementById('qty');
document.getElementById('lenDec').onclick=()=>lenEl.value=Math.max(10,(+lenEl.value||0)-10);
document.getElementById('lenInc').onclick=()=>lenEl.value=(+lenEl.value||0)+10;
document.getElementById('qtyDec').onclick=()=>qtyEl.value=Math.max(1,(+qtyEl.value||1)-1);
document.getElementById('qtyInc').onclick=()=>qtyEl.value=(+qtyEl.value||1)+1;

// toolbar/buttons
document.getElementById('dotMode').onclick=()=>{ dotMode=!dotMode; document.getElementById('dotMode').textContent='Dot Mode: '+(dotMode?'ON':'OFF'); };
document.getElementById('undo').onclick=()=>{ if(history.length){ redoStack.push(JSON.stringify(path)); path=JSON.parse(history.pop()); draw(); } };
document.getElementById('redo').onclick=()=>{ if(redoStack.length){ history.push(JSON.stringify(path)); path=JSON.parse(redoStack.pop()); draw(); } };
document.getElementById('zoom').oninput=e=>{ Z=parseFloat(e.target.value||'1'); draw(); };
document.getElementById('scale').onchange=e=>{ pxPerMm=parseFloat(e.target.value||'1'); draw(); };
document.getElementById('snap').onchange=e=>{ snap=parseInt(e.target.value||'0'); };
document.getElementById('lock').onclick=()=>{ locked=!locked; document.getElementById('lock').textContent=locked?'ðŸ”“ Unlock':'ðŸ”’ Lock'; };

function pushHist(){ history.push(JSON.stringify(path)); if(history.length>200) history.shift(); redoStack.length=0; }
function pos(e){ const r=cv.getBoundingClientRect(); const x=((e.touches?e.touches[0].clientX:e.clientX)-r.left)/Z; const y=((e.touches?e.touches[0].clientY:e.clientY)-r.top)/Z; return {x,y}; }
function snapP(p){ if(!snap) return p; return {x:Math.round(p.x*snap)/snap, y:Math.round(p.y*snap)/snap}; }

function down(e){
  const p=pos(e), sp=snapP(p);
  if(locked){ pickAt({x:p.x*Z,y:p.y*Z}); e.preventDefault(); return; }
  if(dotMode){ if(!path.length){ pushHist(); path=[sp]; } else { pushHist(); path.push(sp); } drawing=true; draw(); e.preventDefault(); return; }
  if(!drawing){ pushHist(); path=[sp]; drawing=true; } else { pushHist(); path.push(sp); } draw(); e.preventDefault();
}
function move(e){ hoverPos=pos(e); if(!path.length||locked){ draw(); return; } if(dotMode){ draw(); return; } if(drawing){ path[path.length-1]=snapP(pos(e)); draw(); } }
function up(e){ e.preventDefault(); }

cv.addEventListener('pointerdown',down,{passive:false});
cv.addEventListener('pointermove',move,{passive:false});
cv.addEventListener('pointerup',up,{passive:false});
cv.addEventListener('touchstart',down,{passive:false});
cv.addEventListener('touchmove',move,{passive:false});
cv.addEventListener('touchend',up,{passive:false});
cv.addEventListener('mousedown',down); cv.addEventListener('mousemove',move);
['mouseup','mouseleave'].forEach(ev=>cv.addEventListener(ev,up));

// geometry
function segs(){ const s=[]; for(let i=0;i<path.length-1;i++) s.push([path[i],path[i+1],i]); return s; }
function normal(ax,ay,bx,by){ const dx=bx-ax, dy=by-ay; const L=Math.hypot(dx,dy)||1; return {x:-dy/L, y:dx/L}; }
function cornerAngle(prev,pt,next){
  const v1={x:prev.x-pt.x,y:prev.y-pt.y}, v2={x:next.x-pt.x,y:next.y-pt.y};
  const dot=v1.x*v2.x+v1.y*v2.y, l1=Math.hypot(v1.x,v1.y), l2=Math.hypot(v2.x,v2.y);
  if(l1*l2===0) return 0;
  let ang=Math.acos(Math.max(-1,Math.min(1,dot/(l1*l2))));
  return +(Math.min(ang*180/Math.PI,180)).toFixed(1);
}

// draw helpers
function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); }
function drawBadge(cx,cy,text){ ctx.font='12px system-ui,-apple-system'; const w=ctx.measureText(text).width+12,h=18; ctx.fillStyle='#d00'; roundRect(ctx,cx-w/2,cy-h/2,w,h,9); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(text,cx-w/2+6,cy+4); }

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height); if(!path.length) return;
  ctx.save(); ctx.scale(Z,Z);
  ctx.strokeStyle='#000'; ctx.lineWidth=2/Z; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); for(let i=1;i<path.length;i++) ctx.lineTo(path[i].x,path[i].y); ctx.stroke();
  const face=faceSel.value,hex=colourSel.value; ctx.strokeStyle=hex; ctx.lineWidth=6/Z; ctx.globalAlpha=.35;
  for(let i=0;i<path.length-1;i++){ const a=path[i],b=path[i+1]; const n=normal(a.x,a.y,b.x,b.y); const off=face==='left'?6:-6; ctx.beginPath(); ctx.moveTo(a.x+n.x*off,a.y+n.y*off); ctx.lineTo(b.x+n.x*off,b.y+n.y*off); ctx.stroke(); } ctx.globalAlpha=1;
  ctx.fillStyle='#000'; for(const p of path){ ctx.beginPath(); ctx.arc(p.x,p.y,3/Z,0,Math.PI*2); ctx.fill(); }
  const r=20; ctx.strokeStyle='#555'; ctx.lineWidth=1/Z; ctx.setLineDash([4/Z,3/Z]);
  for(let i=1;i<path.length-1;i++){ const pm=path[i-1],p=path[i],pn=path[i+1]; let a1=Math.atan2(pm.y-p.y,pm.x-p.x), a2=Math.atan2(pn.y-p.y,pn.x-p.x); let d=a2-a1; while(d>Math.PI){a2-=2*Math.PI; d=a2-a1;} while(d<-Math.PI){a2+=2*Math.PI; d=a2-a1;} ctx.beginPath(); ctx.arc(p.x,p.y,r,a1,a2); ctx.stroke(); }
  ctx.setLineDash([]);
  if(dotMode && hoverPos && path.length && !locked){ const a=path[path.length-1],b=snapP(hoverPos); ctx.strokeStyle='#888'; ctx.lineWidth=1.5/Z; ctx.setLineDash([6/Z,6/Z]); ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); ctx.setLineDash([]); }
  ctx.restore();
  for(let i=0;i<path.length-1;i++){ const a=path[i],b=path[i+1]; const L=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; const midx=(a.x+b.x)/2*Z, midy=(a.y+b.y)/2*Z; drawBadge(midx,midy,Math.round(L)+' mm'); }
  for(let i=1;i<path.length-1;i++){ const ang=cornerAngle(path[i-1],path[i],path[i+1]); drawBadge(path[i].x*Z+8, path[i].y*Z-8, ang+'Â°'); }
}

// inline edit
function clearInline(){ overlay.innerHTML=''; }
function showInline(x,y,value,onEnter){ clearInline(); const wrap=document.createElement('div'); wrap.className='inline-input'; wrap.style.left=x+'px'; wrap.style.top=y+'px'; const inp=document.createElement('input'); inp.value=value; wrap.appendChild(inp); overlay.appendChild(wrap); inp.focus(); inp.select(); inp.addEventListener('keydown',ev=>{ if(ev.key==='Enter'){ onEnter(parseFloat(inp.value)); clearInline(); draw(); } if(ev.key==='Escape'){ clearInline(); draw(); } }); }
function pickAt(sp){
  let bestKind=null,bestIndex=-1,bestd=1e9,bestPt=null;
  for(let i=0;i<path.length-1;i++){ const a=path[i],b=path[i+1]; const mx=(a.x+b.x)/2*Z,my=(a.y+b.y)/2*Z; const d=Math.hypot(sp.x-mx,sp.y-my); if(d<bestd){ bestd=d; bestKind='seg'; bestIndex=i; bestPt={x:mx,y:my}; } }
  for(let i=1;i<path.length-1;i++){ const bx=path[i].x*Z+8,by=path[i].y*Z-8; const d=Math.hypot(sp.x-bx,sp.y-by); if(d<bestd){ bestd=d; bestKind='corner'; bestIndex=i; bestPt={x:bx,y:by}; } }
  if(bestd<42){
    if(bestKind==='seg'){ const a=path[bestIndex],b=path[bestIndex+1]; const dx=b.x-a.x,dy=b.y-a.y; const lengthMm=Math.hypot(dx,dy)/pxPerMm; showInline(bestPt.x,bestPt.y,Math.round(lengthMm),(newLen)=>{ const ang=Math.atan2(-dy,dx); const L=(newLen||0)*pxPerMm; path[bestIndex+1]={x:a.x+L*Math.cos(ang),y:a.y-L*Math.sin(ang)}; }); }
    else { const ang=cornerAngle(path[bestIndex-1],path[bestIndex],path[bestIndex+1]); showInline(bestPt.x,bestPt.y,ang,(newAng)=>{ applyCorner(bestIndex,newAng); }); }
  }
}
function applyCorner(i,deg){
  if(path.length<3) return;
  i=Math.max(1,Math.min(i,path.length-2));
  const desired=Math.max(0,Math.min(180,parseFloat(deg)||0))*Math.PI/180;
  const Pm=path[i-1],P=path[i],Pn=path[i+1];
  const vPrev={x:P.x-Pm.x,y:P.y-Pm.y}; const thetaPrev=Math.atan2(vPrev.y,vPrev.x);
  const delta=Math.PI - desired; const cur=Math.atan2(Pn.y-P.y,Pn.x-P.x);
  const opt1=thetaPrev+delta,opt2=thetaPrev-delta;
  function wrap(a){ return Math.atan2(Math.sin(a), Math.cos(a)); }
  const d1=Math.abs(wrap(cur-opt1)), d2=Math.abs(wrap(cur-opt2));
  const theta=d1<=d2?opt1:opt2;
  const L=Math.hypot(Pn.x-P.x,Pn.y-P.y);
  path[i+1]={x:P.x+L*Math.cos(theta), y:P.y+L*Math.sin(theta)};
  draw();
}

document.getElementById('apply').onclick=()=>{
  if(path.length<2) return;
  const i=Math.min(parseInt(document.getElementById('seg').value||'0',10), path.length-2);
  const a=path[i];
  const L=(parseFloat(document.getElementById('segLen').value)||0)*pxPerMm;
  const ang=(parseFloat(document.getElementById('segAng').value)||0)*Math.PI/180;
  path[i+1]={x:a.x+L*Math.cos(ang), y:a.y-L*Math.sin(ang)};
  draw();
};

// orders
function snapshot(){ return cv.toDataURL('image/png'); }
function foldCount(){ return Math.max(0, path.length-1); }
function girth(){ let g=0; for(let i=0;i<path.length-1;i++){ const a=path[i],b=path[i+1]; g+=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; } return Math.round(g); }
const orders=[];
function addToOrder(){
  if(path.length<2){ alert('Draw first'); return; }
  const item={
    id:String(Date.now()), name:document.getElementById('name').value||'Flashing',
    length_mm:parseInt(lenEl.value||'0',10), qty:parseInt(qtyEl.value||'1',10),
    gauge:document.getElementById('gauge').value||'0.55',
    colourName:colourSel.options[colourSel.selectedIndex].text, colourHex:colourSel.value, face:faceSel.value,
    F:foldCount(), GIRTH:girth(), T:(girth()/1000).toFixed(1), image:snapshot(), notes:''
  };
  orders.push(item); renderOrders();
}
document.getElementById('actAdd').onclick=addToOrder;
document.getElementById('clearOrders').onclick=()=>{ orders.length=0; renderOrders(); };

function renderOrders(){
  const body=document.getElementById('orderBody'); body.innerHTML='';
  document.getElementById('orderCount').textContent=String(orders.length);
  for(let i=0;i<orders.length;i++){
    const o=orders[i];
    const tr=document.createElement('tr'); tr.setAttribute('data-i', String(i));
    tr.innerHTML = '<td><img src="'+o.image+'" style="width:120px;height:auto;border:1px solid #ddd;border-radius:6px"></td>'
      + '<td>'+o.name+'</td><td>'+o.colourName+'</td><td>'+o.gauge+'</td><td>'+o.F+'</td><td>'+o.GIRTH+'</td>'
      + '<td><div style="display:flex;gap:6px;align-items:center">'
      +   '<input class="cell-qty" type="number" min="1" step="1" value="'+o.qty+'" style="width:68px"> Ã— '
      +   '<input class="cell-length" type="number" min="10" step="10" value="'+o.length_mm+'" style="width:90px"> mm'
      + '</div></td>'
      + '<td>'+o.T+'</td>'
      + '<td contenteditable="true" class="cell-notes">'+(o.notes||'')+'</td>'
      + '<td><button class="btn btn-del" data-del="'+i+'">Remove</button></td>';
    body.appendChild(tr);
  }
  body.querySelectorAll('.btn-del').forEach(b=> b.onclick=()=>{ const i=parseInt(b.getAttribute('data-del')); orders.splice(i,1); renderOrders(); });
  body.querySelectorAll('tr').forEach(row=>{
    const i=parseInt(row.getAttribute('data-i'));
    const qtyIn=row.querySelector('.cell-qty');
    const lenIn=row.querySelector('.cell-length');
    const notesEl=row.querySelector('.cell-notes');
    qtyIn.addEventListener('change', ()=>{ orders[i].qty=Math.max(1, parseInt(qtyIn.value||'1',10)); });
    lenIn.addEventListener('change', ()=>{ orders[i].length_mm=Math.max(10, parseInt(lenIn.value||'10',10)); });
    notesEl.addEventListener('input', ()=>{ orders[i].notes=notesEl.textContent; });
  });
}

// email
document.getElementById('emailOrders').onclick=()=>{
  if(!orders.length){ alert('No items'); return; }
  const lines=orders.map((o,i)=> (i+1)+'. '+o.name+' x'+o.qty+' â€” '+o.length_mm+'mm, '+o.gauge+', '+o.colourName+' (F:'+o.F+' G:'+o.GIRTH+' T:'+o.T+')').join('\n');
  location.href='mailto:?subject=MR Flashing Order&body='+encodeURIComponent(lines);
};

// Orders PDF
document.getElementById('exportOrders').onclick=()=>{
  if(!orders.length){ alert('No items'); return; }
  const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt', format:'a4'});
  let y=40;
  doc.setFontSize(14); doc.setTextColor(0,58,117); doc.text('MATRIX ROOFING â€” MR FLASHING ORDER', 40, y); y+=24;
  doc.setTextColor(0,0,0); doc.setFontSize(9);
  function row(c){ let x=40; const w=[80,90,50,40,60,100,50,120]; for(let i=0;i<c.length;i++){ doc.rect(x,y,w[i],18); doc.text(String(c[i]), x+6, y+12); x+=w[i]; } y+=18; }
  row(['Name','Colour','Gauge','F','GIRTH','Q Ã— L (mm)','T','Notes']);
  orders.forEach(o=> row([o.name,o.colourName,o.gauge,o.F,o.GIRTH,(o.qty+' Ã— '+o.length_mm),o.T,(o.notes||'')]));
  y+=16; doc.setFontSize(8);
  doc.text('Matrix Roofing â€” Roof Restorations & Custom Flashings Â· Melbourne VIC Â· 1300 980 779 Â· www.matrixroofing.com.au', 40, y);
  doc.save('mr-flashing-order.pdf');
};

// save/load/share
function currentDesign(){ return { meta:{app:'MR Flashing',version:'v5.9',brand:'Matrix Roofing',ts:Date.now()}, drawing:{ path:path.map(p=>({x:p.x,y:p.y})), pxPerMm:pxPerMm, Z:Z, snap:snap, colourHex:colourSel.value, face:faceSel.value }, item:{ name:document.getElementById('name').value, length_mm:parseInt(lenEl.value||'0',10), gauge:document.getElementById('gauge').value, qty:parseInt(qtyEl.value||'1',10) } }; }
function applyDesign(d){ if(!d) return; path=d.drawing&&d.drawing.path?d.drawing.path:[]; pxPerMm=d.drawing&&d.drawing.pxPerMm?d.drawing.pxPerMm:1; Z=d.drawing&&d.drawing.Z?d.drawing.Z:1; snap=d.drawing&&d.drawing.snap?d.drawing.snap:6; if(d.drawing&&d.drawing.colourHex) colourSel.value=d.drawing.colourHex; if(d.drawing&&d.drawing.face) faceSel.value=d.drawing.face; document.getElementById('zoom').value=Z; document.getElementById('scale').value=pxPerMm; document.getElementById('snap').value=snap; document.getElementById('name').value=d.item&&d.item.name?d.item.name:'Flashing'; lenEl.value=d.item&&d.item.length_mm?d.item.length_mm:2400; document.getElementById('gauge').value=d.item&&d.item.gauge?d.item.gauge:'0.55'; qtyEl.value=d.item&&d.item.qty?d.item.qty:1; swatch.style.background=colourSel.value; draw(); }
document.getElementById('actNew').onclick=()=>{ if(path.length>1 && !confirm('Clear current drawing?')) return; path=[]; history.length=0; redoStack.length=0; draw(); };
document.getElementById('actSave').onclick=()=>{ const d=currentDesign(); localStorage.setItem('mr-flashing-v59', JSON.stringify(d)); const blob=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(d.item&&d.item.name?d.item.name:'design')+'.mrfl.json'; a.click(); };
document.getElementById('actLoad').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,.mrfl.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ applyDesign(JSON.parse(r.result)); }catch(e){ alert('Invalid file'); } }; r.readAsText(f); }; inp.click(); };
document.getElementById('actShare').onclick=()=>{ const enc=btoa(unescape(encodeURIComponent(JSON.stringify(currentDesign())))); const url=location.origin+location.pathname+'#d='+enc; if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(url); alert('Share link copied to clipboard.'); } else { prompt('Copy this link:', url); } };

(function init(){ const hash=location.hash||''; if(hash.indexOf('#d=')===0){ try{ applyDesign(JSON.parse(decodeURIComponent(escape(atob(hash.slice(3)))))); return; }catch(e){} } const saved=localStorage.getItem('mr-flashing-v59'); if(saved){ try{ applyDesign(JSON.parse(saved)); }catch(e){} } draw(); })();

// current design PDF
function girthFromPath(p){ let s=0; for(let i=0;i<p.length-1;i++){ const a=p[i],b=p[i+1]; s+=Math.hypot(b.x-a.x,b.y-a.y)/pxPerMm; } return Math.round(s); }
function exportPDF(){ const { jsPDF } = window.jspdf; const doc=new jsPDF({unit:'pt', format:'a4'}); let y=40; doc.setFontSize(14); doc.setTextColor(0,58,117); doc.text('MATRIX ROOFING â€” MR FLASHING DESIGN',40,y); y+=24; doc.setTextColor(0,0,0); doc.setFontSize(10); doc.text('Generated: '+new Date().toLocaleString(),40,y); y+=16; doc.setFontSize(9); doc.text('â€¢ Arrow points to the (solid) coloured side',40,y); y+=14; doc.text('â€¢ 90Â° degrees are not labelled',40,y); y+=14; doc.text('â€¢ F = Total number of folds (each crush counts as 2)',40,y); y+=20; function cell(x,w,txt){ doc.rect(x,y,w,18); doc.text(String(txt), x+6, y+12);} let x=40; cell(x,240,'Colour / Material'); x+=240; cell(x,60,'F'); x+=60; cell(x,60,'GIRTH'); x+=60; cell(x,80,'Q Ã— L'); x+=80; cell(x,60,'T'); x+=60; y+=18; x=40; const colourName=colourSel.options[colourSel.selectedIndex].text; const f=foldCount(), g=girthFromPath(path); cell(x,240,colourName); x+=240; cell(x,60,f); x+=60; cell(x,60,g); x+=60; cell(x,80,(qtyEl.value+' Ã— '+lenEl.value)); x+=80; cell(x,60,(g/1000).toFixed(1)); x+=60; y+=26; const img=cv.toDataURL('image/png'); doc.addImage(img,'PNG',40,y+6,420,240); y+=260; doc.setFontSize(9); doc.text('Matrix Roofing â€” Roof Restorations & Custom Flashings Â· Melbourne VIC Â· 1300 980 779 Â· www.matrixroofing.com.au',40,y); doc.save('mr-flashing-design.pdf'); }
document.getElementById('actExport').onclick=exportPDF;
</script>
</body>
</html>
